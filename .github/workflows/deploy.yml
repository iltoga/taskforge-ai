name: Deploy CalendarGPT to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Add GitHub.com to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: SSH into VPS and deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 30m
          command_timeout: 30m
          script: |
            # Check and setup repository
            REPO_DIR="$HOME/.docker/calendar-gpt"
            echo "Pulling latest changes."
            cd "$REPO_DIR"
            # Ensure remote URL is correct using the custom SSH configuration
            GIT_SSH_COMMAND="git remote set-url origin git@github.com-deploy-calendargpt:iltoga/calendarGPT.git
            # Ensure we're on the main branch and clean any local changes
            GIT_SSH_COMMAND=git fetch --all
            GIT_SSH_COMMAND=git checkout main
            GIT_SSH_COMMAND=git reset --hard origin/main
            GIT_SSH_COMMAND=git clean -fd
            GIT_SSH_COMMAND=pull origin main

            # Set permissions
            # sudo chown -R nespola:nespola "$REPO_DIR"

            # Deploy with Docker
            cd "$REPO_DIR"
            export DOCKER_BUILDKIT=1

            # Clear Docker build cache to ensure fresh builds
            docker builder prune -f

            # Source environment variables if available
            if [ -f .env ]; then
              source .env
            fi

            # Build and restart services
            docker compose build --no-cache --pull calendar-gpt
            docker compose down calendar-gpt
            docker compose up -d calendar-gpt

            # Clean up - Comment this out initially for debugging
            docker system prune -af --volumes
            echo "Deployment of calendarGPT completed successfully"
